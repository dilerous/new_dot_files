!function(a){function b(b){M=!0;try{b=Encryption.decryptMessage(b,U),ha=!0,u(),M=!0}catch(e){if("Malformed UTF-8 data"===e.message&&!ha)return void(M=!1)}try{b=JSON.parse(b)}catch(e){}if(b.login&&(Z[0]?g(Z[0],b):f(function(a){g(a,b)})),b.httpauthentication){var d=b.httpauthentication;X.tabRequest[d.tabID]&&(X.tabRequest[d.tabID].credential={targetUrl:d.url,targetDomain:d.domain,encrypted:Encryption.encryptMessage(JSON.stringify({username:d.username,password:d.password}),U)},chrome.tabs.update(d.tabID,{url:d.url}))}b.creditCard&&(Z[0]?h(Z[0],b):f(function(a){h(a,b)})),b.identity&&f(function(a){j(b)}),b.configure&&(b.configure.shortcut&&chrome.storage.local.get("enpass_shortcut_override",function(a){a.enpass_shortcut_override?ga=!0:(ga=!1,chrome.storage.local.set({enpass_shortcut:b.configure.shortcut.key}),s(b.configure.shortcut.key))}),b.configure.error&&(L=b.configure.error),b.configure.public_key&&(U=a.to_hex(a.crypto_box_beforenm(a.from_hex(b.configure.public_key),V.privateKey)))),b.fillGeneratedPassword&&c({header:"fillGeneratedPassword",generatedPassword:b.fillGeneratedPassword}),b.currentTabInfo&&f(function(a){var c={data:{tabUrl:a.url,cardUUID:b.currentTabInfo.cardUUID},type:"currentTabInfo"};0===a.url.indexOf("http")&&H.send(Encryption.encryptMessage(JSON.stringify(c),U))})}function c(a,b){chrome.tabs.query({active:!0,currentWindow:!0},function(c){c[0]&&chrome.tabs.sendMessage(c[0].id,a,b)})}function d(a,b,c){chrome.tabs.sendMessage(a,b,c)}function e(a){chrome.tabs.query({},function(b){for(var c=0;c<b.length;++c)chrome.tabs.sendMessage(b[c].id,a)})}function f(a){chrome.tabs.query({currentWindow:!0,active:!0},function(b){a(b[0])})}function g(a,b){if(!b.login.tabId||a.id===b.login.tabId){var c={};c.header="enpass_loginfill",c.card=b.login;var e=b.login.domain,f=!1,g=a.url;if(e&&g&&(f=r(g,e)),b.login.url)if(f)d(a.id,c);else{if(b.login.isURLFillResponse)return;var h=function(a,e,f){if("complete"===f.status&&W&&a&&W===a){var g=x(b.login.url);-1!==f.url.indexOf(g)&&d(a,c),W=null,chrome.tabs.onUpdated.removeListener(h)}};(g===T||g==R||g===S)&&a&&a.id?a&&a.id&&(X.tabRequest[a.id]={credential:{targetUrl:b.login.url,targetDomain:b.login.domain,encrypted:Encryption.encryptMessage(JSON.stringify({username:b.login.username,password:b.login.password}),U)}},W=a.id,chrome.tabs.update(a.id,{url:b.login.url})):chrome.tabs.create({url:b.login.url},function(a){X.tabRequest[a.id]={credential:{targetUrl:b.login.url,targetDomain:b.login.domain,encrypted:Encryption.encryptMessage(JSON.stringify({username:b.login.username,password:b.login.password}),U)}},W=a.id,chrome.tabs.update(a.id,{url:a.url})}),chrome.tabs.onUpdated.addListener(h)}else d(a.id,c),aa[a.id]=C(b.login.username+b.login.password)}}function h(a,b){var c={};c.header="enpass_cardfill",c.card={ccnumber:b.creditCard.number,holderName:b.creditCard.name,cvv:b.creditCard.cvv,cardtype:b.creditCard.type,month:b.creditCard.expiry_month,year:b.creditCard.expiry_year},d(a.id,c)}function j(a){var b={};b.header="enpass_identityfill",b.card={email:a.identity.email,username:a.identity.username,fname:a.identity.fname,lname:a.identity.lname,mname:a.identity.mname,mobile:a.identity.phone,day:a.identity.day,month:a.identity.month,year:a.identity.year,state:a.identity.state,city:a.identity.city,sex:a.identity.sex,country:a.identity.country_name,zip:a.identity.zip,address:a.identity.address,company:a.identity.company,jobtitle:a.identity.jobtitle,occupation:a.identity.occupation},c(b)}function k(a){if(a){var b=0;for(var c in a)"about:blank"!==a[c].url&&b++;return b}return 0}function l(a,b){var c=!(!a.isLogin&&!a.isCreditCard)||b.recievingFrame===b.totalFramesInCurrentTab&&b.isFurtherFrameResponseNeeded;c&&(ca&&(ca=!1,clearTimeout(da)),b.isFurtherFrameResponseNeeded=!1,f(function(b){delete a.header;var c={};c.data=a,c.uuid=H.uuid,c.data.tabUrl=b.url,c.type="click",H.send(Encryption.encryptMessage(JSON.stringify(c),U))}))}function m(){Y.isFurtherFrameResponseNeeded=!0,Y.totalFramesInCurrentTab=0,Y.recievingFrame=0}function n(a){M||1!==H.readyState?1!==H.readyState?(chrome.windows.getCurrent({populate:!0},function(a){a.tabs.length>1?chrome.tabs.query({url:Q},function(a){if(a&&a[0]){if(O)return void chrome.tabs.update(a[0].id,{active:!0});chrome.tabs.remove(a[0].id,function(){_=null,N?setTimeout(function(){t()},100):t()})}else t()}):chrome.tabs.query({url:Q},function(a){a&&a[0]&&(O?chrome.tabs.update(a[0].id,{active:!0}):D()?chrome.tabs.create({url:S,active:!0}):chrome.tabs.create({url:T,active:!0})),t()})}),1!==H.readyState&&(K||(K=!0,setTimeout(function(){K=!1},5e3),H.refresh()))):f(function(a){var b=a.url;if(0!==b.indexOf("chrome")&&0!==b.indexOf("file")&&navigator.onLine)m(),chrome.webNavigation.getAllFrames({tabId:a.id},function(a){Y.totalFramesInCurrentTab=k(a)}),ca=!0,da=setTimeout(function(){ca=!1,Y.isFurtherFrameResponseNeeded=!1;var b={};b.data={isLogin:!1,isHttpAuthentication:!!X.tabRequest[a.id],tabID:a.id},b.uuid=H.uuid,b.data.tabUrl=a.url,b.type="click",H.send(Encryption.encryptMessage(JSON.stringify(b),U))},400),c({header:"guess_form"});else{var d={};d.data={},d.uuid=H.uuid,d.data.tabUrl=b,d.type="click",H.send(Encryption.encryptMessage(JSON.stringify(d),U))}}):(u(),_={header:"error_page",container_header:"Upgrade Enpass App",container_description:"Your Enpass desktop application seems too old to shake hands with Browser Extension. Please update main Enpass App to latest available version.",display_btn:!1},w("data/chromeUI/enpass_error.html",_))}function o(a,b){var c=new RegExp("[\\?&]"+a+"=([^&#]*)").exec(b);if(c)return c[1]||void 0}function p(a){var b=null;b=decodeURIComponent(a);try{return JSON.parse(atob(b))}catch(c){return}}function q(a){var b=a.indexOf("EnpassAutoFill")-1;return a.slice(0,b)}function r(a,b){if(!b)return!1;var c=b.split(",");a=x(a);for(var d=0;d<c.length;++d)if(-1!==a.indexOf(c[d]))return!0;return!1}function s(a,b){var d={};d.header="set_shortcut_for_autofill",d.shortcutKey=a||!1,d.isShortcutOverride=ga,b?c(d):e(d)}function t(){chrome.windows.getAll({populate:!0},function(a){a.forEach(function(a){if(a.focused){a.tabs.some(function(a){return!(!a.url||a.url!==Q)&&(L&&403===L.code?(_={header:"error_page",container_header:"Access Denied! Error 403",container_description:"Browser's code signature verification failed. Filling and other features are disabled until this configuration issue is resolved. Please E-mail the diagnostics below to us at support@enpass.io.",display_btn:!1,logs:L.logs},v(a.id,"data/chromeUI/enpass_error.html",_)):(_={header:"error_page",container_header:"Enpass Connection Error",container_description:'Please start Enpass desktop app and make sure you have checked "Enable Browser Extension" in Enpass Preferences, before using Enpass Browser Extension.',display_btn:!0},v(a.id,"data/chromeUI/enpass_error.html",_)),!0)})||(L&&403===L.code?(_={header:"error_page",container_header:"Access Denied! Error 403",container_description:"Browser's code signature verification failed. Filling and other features are disabled until this configuration issue is resolved. Please E-mail the diagnostics below to us at support@enpass.io.",display_btn:!1,logs:L.logs},w("data/chromeUI/enpass_error.html",_)):(_={header:"error_page",container_header:"Enpass Connection Error",container_description:'Please start Enpass desktop app and make sure you have checked "Enable Browser Extension" in Enpass Preferences, before using Enpass Browser Extension.',display_btn:!0},w("data/chromeUI/enpass_error.html",_)))}})})}function u(){chrome.windows.getAll({populate:!0},function(a){a.forEach(function(a){a.tabs.forEach(function(a){a.url&&a.url===Q&&(O?chrome.tabs.update(a.id,{url:R}):D()?chrome.tabs.update(a.id,{url:S}):chrome.tabs.update(a.id,{url:T}))})})})}function v(a,b,c){chrome.tabs.update(a,{selected:!0},function(a){d(a.id,c)})}function w(a,b){a=chrome.extension.getURL(a),chrome.tabs.create({url:a,active:!0},function(a){d(a.id,b)})}function x(a){var b=document.createElement("a");return b.href=a,0===b.host.indexOf("www")?b.host.slice(4):b.host}function y(){O||(ea=setInterval(function(){chrome.windows.getCurrent(function(a){N&&P&&!fa&&setTimeout(function(){fa=!0},500),a&&(a.focused&&fa&&1!==H.readyState?(fa=!1,L={},H.refresh()):a.focused||(fa=!0))})},1e3))}function z(a){var b=chrome.runtime.getManifest(),c={type:"connected",data:{browser:"",appVersion:b.version}};a&&(c.data.public_key=a),D()?c.data.browser="firefox":c.data.browser=O?"vivaldi":N?"opera":"chrome",H.send(Encryption.encryptMessage(JSON.stringify(c),U))}function A(){L={},M=!1,Y={totalFramesInCurrentTab:0,recievingFrame:0,isFurtherFrameResponseNeeded:!0},$={},aa={},ba=!1,ca=!1,da=0,ea=0,fa=!1,ha=!1,U=null,V=null}function B(a){var b=o("EnpassAutoFill",a.url);if(b){var c=p(b),d=q(a.url);chrome.tabs.update(a.tabId,{url:d,active:!0});var e=function(a,b,d){if("complete"===d.status){Z.pop(),Z.push(d);var f={type:"urlFillRequested",data:{selectedCardUUID:c.autofillFromApp.selectedCardUUID,selectedCardFieldUID:c.autofillFromApp.selectedCardFieldUID}};H.send(Encryption.encryptMessage(JSON.stringify(f),U)),chrome.tabs.onUpdated.removeListener(e)}};chrome.tabs.onUpdated.addListener(e)}}function C(a){var b=0;if(0===a.length)return b;for(i=0;i<a.length;i++)char=a.charCodeAt(i),b=(b<<5)-b+char,b&=b;return b}function D(){return null!==(navigator&&navigator.userAgent||"").toLowerCase().match(/(?:firefox|fxios)\/(\d+)/)}function E(a){X.tabRequest[a.tabId]=null,delete X.tabRequest[a.tabId]}function F(a){var b=X.tabRequest[a.tabId];if(b&&b.requestId&&b.requestId===a.requestId)return{cancel:!0};if(b&&b.credential&&r(a.url,b.credential.targetDomain)){b.requestId=a.requestId;var c=Encryption.decryptMessage(b.credential.encrypted,U);return{authCredentials:JSON.parse(c)}}X.tabRequest[a.tabId]={}}var G=["ws://127.0.0.1:10391","ws://127.0.0.1:10392","ws://127.0.0.1:10393","ws://127.0.0.1:10394","ws://127.0.0.1:10395"],H=new ReconnectingWebSocket(G),I=0,J=!1,K=!1,L={},M=!1,N=navigator.userAgent.indexOf(" OPR/")>=0,O=navigator.userAgent.indexOf(" Vivaldi/")>=0,P=-1!==navigator.appVersion.indexOf("Linux"),Q=chrome.extension.getURL("/data/chromeUI/enpass_error.html"),R="chrome-extension://mpognobbkildjkofajifpdfhcoklimli/components/startpage/startpage.html?section=Speed-dials&activeSpeedDialIndex=0",S="about:blank",T="chrome://newtab/",U=null,V=null,W=null,X={tabRequest:{}},Y={totalFramesInCurrentTab:0,recievingFrame:0,isFurtherFrameResponseNeeded:!0},Z=[],$={},_=null,aa={},ba=!1,ca=!1,da=0,ea=0,fa=!1,ga=!1,ha=!1;H.debug=!1,H.timeoutInterval=1e3,H.onopen=function(){u(),V=a.crypto_box_keypair(),z(a.to_hex(V.publicKey))},H.onclose=function(a){y(),U=null,V=null},H.onmessage=function(a){b(a.data)},H.onerror=function(a){A()},chrome.storage.local.get("enpass_shortcut_override",function(a){ga=!!a.enpass_shortcut_override}),chrome.storage.onChanged.addListener(function(a,b){a.enpass_shortcut_override&&"local"===b&&(ga=!!a.enpass_shortcut_override.newValue)}),chrome.webRequest.onCompleted.addListener(E,{urls:["<all_urls>"]}),chrome.webRequest.onAuthRequired.addListener(F,{urls:["<all_urls>"]},["blocking"]),chrome.runtime.onInstalled.addListener(function(a){"install"===a.reason&&(-1!==navigator.appVersion.indexOf("Mac")?chrome.storage.local.set({enpass_shortcut:"meta+/"}):chrome.storage.local.set({enpass_shortcut:"ctrl+/"}),chrome.storage.local.set({enpass_shortcut_override:!1}))}),chrome.windows.onFocusChanged.addListener(function(a){1!==H.readyState&&O&&H.refresh()}),chrome.tabs.onActivated.addListener(function(a){c({header:"setActiveTabInfo",tabId:a.tabId}),f(function(a){var b=chrome.extension.getURL("data/chromeUI/enpass_error.html");a&&a.url===b&&!J?(J=!0,1===H.readyState||0!==H.reconnectAttempts||K||H.refresh(),I=setInterval(function(){1!==H.readyState&&0===H.reconnectAttempts&&H.refresh()},5e3)):(J=!1,clearInterval(I))})}),chrome.browserAction.onClicked.addListener(function(a){Z.pop(),Z.push(a),n(a)}),chrome.webNavigation.onErrorOccurred.addListener(function(a){ba=!0}),chrome.webNavigation.onBeforeNavigate.addListener(function(a){if(ba=!1,a&&0===a.frameId){var b=o("EnpassAutoFill",a.url);if(b){var c=p(b),d=q(a.url);chrome.tabs.update(a.tabId,{url:d,active:!0},function(a){Z.pop(),Z.push(a)});var e=function(a,b,d){if("complete"===d.status&&c){var f={type:"urlFillRequested",data:{selectedCardUUID:c.autofillFromApp.selectedCardUUID,selectedCardFieldUID:c.autofillFromApp.selectedCardFieldUID}};H.send(Encryption.encryptMessage(JSON.stringify(f),U)),chrome.tabs.onUpdated.removeListener(e)}};chrome.tabs.onUpdated.addListener(e)}}}),chrome.contextMenus.create({id:"enpassContextMenu",title:"Enpass",contexts:["all"]}),chrome.contextMenus.onClicked.addListener(function(a,b){Z.pop(),Z.push(b),n(b)}),chrome.runtime.onMessage.addListener(function(a,b,c){var e={};switch(a.header){case"loginSubmitEvent":delete a.header,e={},e.data=a,chrome.tabs.query({currentWindow:!0,active:!0},function(b){var c=b[0];a&&(!a.tabId||c&&c.id===a.tabId)&&(delete a.tabId,e.data.tabUrl=c.url,e.type="saveUpdate",e.uuid=H.uuid,aa[c.id]===C(a.username+a.password)?delete aa[c.id]:H.send(Encryption.encryptMessage(JSON.stringify(e),U)))});break;case"changePswdSubmitEvent":delete a.header,e={},e.data=a,f(function(a){e.type="updatePassword",e.data.tabUrl=a.url,e.uuid=H.uuid,H.send(Encryption.encryptMessage(JSON.stringify(e),U))});break;case"guess_form_result":++Y.recievingFrame,l(a,Y);break;case"shortcutPressed":delete a.header,delete a.tabId,e={},e.data=a,f(function(a){Z.pop(),Z.push(a),e.data.tabUrl=a.url,e.type="shortcutPressed",e.uuid=H.uuid,1!==H.readyState?(t(),H.refresh()):H.send(Encryption.encryptMessage(JSON.stringify(e),U))});break;case"get_shortcut":chrome.storage.local.get("enpass_shortcut",function(a){s(a.enpass_shortcut,!0)});break;case"get_error_desc":_&&d(b.tab.id,_);break;case"newShortcut":s(a.shortcut)}}),chrome.tabs.onUpdated.addListener(function(a,b,e){if("complete"===b.status){chrome.storage.local.get("enpass_shortcut",function(a){e.id&&d(e.id,{header:"set_shortcut_for_autofill",shortcutKey:a.enpass_shortcut,isShortcutOverride:ga})});f(function(a){a&&(B(a),c({header:"setActiveTabInfo",tabId:a.id}))}),chrome.tabs.query({currentWindow:!0,url:Q},function(a){a&&0===a.length&&(clearInterval(I),J=!1)})}}),chrome.tabs.onRemoved.addListener(function(a,b){chrome.tabs.query({currentWindow:!0,url:Q},function(a){a&&0===a.length&&(J=!1,clearInterval(I))})})}(sodium);